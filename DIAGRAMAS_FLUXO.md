# ๐ Diagramas do Fluxo de Verificaรงรฃo de Email

## 1. Fluxo de Registro e Verificaรงรฃo

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     NOVO USUรRIO                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PASSO 1: Frontend - Pรกgina de Registro (/registrar)            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โ Usuรกrio digita email
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PASSO 2: Validaรงรฃo em Tempo Real                               โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ Email: joao@empresa.com.br                              โ   โ
โ  โ Status: โ Domรญnio invรกlido                              โ   โ
โ  โ Mensagem: Domรญnios permitidos: @gmail.com, ...          โ   โ
โ  โ Botรฃo: DESABILITADO                                     โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ Email: joao@gmail.com                                   โ   โ
โ  โ Status: โ Vรกlido                                        โ   โ
โ  โ Mensagem: (nenhuma)                                     โ   โ
โ  โ Botรฃo: HABILITADO                                       โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โ Clicar "Registrar"
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PASSO 3: POST /api/auth/register (Backend)                     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ {                                                       โ   โ
โ  โ   "name": "Joรฃo Silva",                                 โ   โ
โ  โ   "email": "joao@gmail.com",                            โ   โ
โ  โ   "password": "123456"                                  โ   โ
โ  โ }                                                       โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PASSO 4: Backend - Validaรงรฃo                                   โ
โ  โโ Validar domรญnio (2ยช camada de seguranรงa)                    โ
โ  โโ Validar email nรฃo existe                                    โ
โ  โโ Hash de senha com bcrypt                                    โ
โ  โโ Criar usuรกrio no banco com email_verified = 0              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PASSO 5: Gerar Token de Verificaรงรฃo                            โ
โ  โโ Token: crypto.randomBytes(32).toString('hex')              โ
โ  โโ Expiraรงรฃo: Date.now() + 24 * 60 * 60 * 1000 (24h)          โ
โ  โโ Salvar no banco: verification_token, verification_expires  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PASSO 6: Enviar Email                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ Para: joao@gmail.com                                    โ   โ
โ  โ Assunto: Verifique seu email - Pet Well Track           โ   โ
โ  โ Corpo: Link com token                                   โ   โ
โ  โ http://localhost:8080/verificar-email/abc123...        โ   โ
โ  โ Expiraรงรฃo: 24 horas                                     โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PASSO 7: Redirecionar para Verificaรงรฃo Pendente                โ
โ  โโ Frontend: /verificacao-pendente                             โ
โ     โโ Exibe email
โ     โโ Instruรงรตes passo a passo
โ     โโ Botรฃo "Nรฃo recebi o email"
โ     โโ Botรฃo "Jรก verifiquei"
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โ Usuรกrio abre email e clica no link
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PASSO 8: Acessar Link de Verificaรงรฃo                           โ
โ  โโ URL: http://localhost:8080/verificar-email/:token          โ
โ     โโ Pรกgina carrega
โ     โโ Faz requisiรงรฃo para backend
โ     โโ Backend valida token
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PASSO 9: POST /api/auth/verify-email/:token                    โ
โ  โโ Backend busca usuรกrio pelo token
โ  โโ Valida se nรฃo expirou
โ  โโ Marca email_verified = 1
โ  โโ Limpa token e expiraรงรฃo
โ  โโ Retorna sucesso
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PASSO 10: Sucesso!                                             โ
โ  โโ Pรกgina mostra: โ Email verificado com sucesso!             โ
โ  โโ Contador: Redirecionando em 3 segundos...                   โ
โ  โโ Botรฃo: "Ir para Login Agora"                                โ
โ  โโ Redireciona para: /entrar
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PASSO 11: Login (/entrar)                                      โ
โ  โโ Usuรกrio digita email e senha
โ  โโ Backend valida credenciais
โ  โโ Backend valida: email_verified = 1
โ  โโ Gera JWT token
โ  โโ Redireciona para home
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โผ
    โ ACESSO CONCEDIDO
```

---

## 2. Fluxo de Login com Email nรฃo Verificado

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              USUรRIO NรO VERIFICOU EMAIL                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PASSO 1: Frontend - Pรกgina de Login (/entrar)                  โ
โ  โโ Email: joao@gmail.com                                       โ
โ  โโ Senha: 123456                                               โ
โ  โโ Clicar "Entrar"
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PASSO 2: POST /api/auth/login (Backend)                        โ
โ  โโ Validar credenciais
โ  โโ Credenciais vรกlidas โ
โ  โโ Verificar email_verified
โ  โโ email_verified = 0 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PASSO 3: Retornar Erro 403                                     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ {                                                       โ   โ
โ  โ   "success": false,                                     โ   โ
โ  โ   "error": "Por favor, verifique seu email antes de...  โ   โ
โ  โ            fazer login",                                โ   โ
โ  โ   "code": "EMAIL_NOT_VERIFIED"                          โ   โ
โ  โ }                                                       โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PASSO 4: Frontend - Exibir Erro                                โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ โ Por favor, verifique seu email antes de fazer login   โ   โ
โ  โ                                                         โ   โ
โ  โ [Reenviar Email de Verificaรงรฃo]                         โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โ Usuรกrio clica "Reenviar Email"
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PASSO 5: Redirecionar para /reenviar-verificacao               โ
โ  โโ Prรฉ-popular email (se disponรญvel)
โ  โโ Exibir formulรกrio para reenviar
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PASSO 6: POST /api/auth/resend-verification                    โ
โ  โโ Buscar usuรกrio pelo email
โ  โโ Validar email nรฃo verificado
โ  โโ Gerar novo token
โ  โโ Salvar no banco
โ  โโ Enviar email com novo link
โ  โโ Retornar sucesso
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PASSO 7: Frontend - Sucesso                                    โ
โ  โโ Mensagem: "Email de verificaรงรฃo reenviado"
โ  โโ Redireciona para /entrar
โ  โโ Usuรกrio pode verificar email novamente
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โ Usuรกrio clica no link do novo email
         โ
         โผ
    โ Email verificado (volta ao PASSO 10 do fluxo anterior)
```

---

## 3. Arquitetura de Validaรงรฃo

```
                    โโโโโโโโโโโโโโโโโโโ
                    โ  Email Input    โ
                    โ  usuario@gmail  โ
                    โ     .com        โ
                    โโโโโโโโโโฌโโโโโโโโโ
                             โ
                             โผ
                    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ   FRONTEND VALIDATION           โ
                    โ   (em tempo real)               โ
                    โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ  โ isValidEmailDomain()       โโ
                    โ  โ Verifica domรญnio           โโ
                    โ  โ Em: ALLOWED_DOMAINS        โโ
                    โ  โ Resultado: โ ou โ         โโ
                    โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ  Exibe:                        โ
                    โ  - Campo verde/vermelho        โ
                    โ  - Mensagem de erro            โ
                    โ  - Botรฃo enable/disable        โ
                    โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโ
                                 โ
                    Clique "Registrar" (Front OK)
                                 โ
                                 โผ
                    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ   HTTP POST /api/auth/register  โ
                    โ   + Frontend Validation Pass    โ
                    โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโ
                                 โ
                                 โผ
                    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ   BACKEND VALIDATION            โ
                    โ   (por seguranรงa)               โ
                    โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ  โ isValidEmailDomain()       โโ
                    โ  โ Backend version            โโ
                    โ  โ Resultado: โ ou โ         โโ
                    โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ                                 โ
                    โ  Se โ:                         โ
                    โ  โโ Retorna 400                 โ
                    โ  โโ Erro: Domรญnio invรกlido     โ
                    โ                                 โ
                    โ  Se โ:                         โ
                    โ  โโ Continua registro           โ
                    โ  โโ Valida email รบnico         โ
                    โ  โโ Hash senha                  โ
                    โ  โโ Cria usuรกrio               โ
                    โ  โโ Passa para prรณxima camada   โ
                    โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโ
                                 โ
                                 โผ
                    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ   GERAรรO DE TOKEN              โ
                    โ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ   โ verification_token:         โโ
                    โ   โ crypto.randomBytes(32)      โโ
                    โ   โ                             โโ
                    โ   โ verification_expires:       โโ
                    โ   โ Date.now() + 24h            โโ
                    โ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                    โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโ
                                 โ
                                 โผ
                    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ   ENVIO DE EMAIL                โ
                    โ   + Nodemailer SMTP             โ
                    โ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ   โ Para: usuario@gmail.com     โโ
                    โ   โ Link: /verificar-email/    โโ
                    โ   โ       TOKEN                 โโ
                    โ   โ Expira: 24 horas            โโ
                    โ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                    โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโ
                                 โ
                                 โผ
                        โ REGISTRO COMPLETO
```

---

## 4. Estados do Usuรกrio

```
โโโโโโโโโโโโโโโโโโโ
โ  Novo Usuรกrio   โ  Acessa /registrar
โโโโโโโโโโฌโโโโโโโโโ
         โ
         โผ
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ NรO VERIFICADO              โ  email_verified = 0
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
    โ Permissรตes:                 โ
    โ โ Fazer login              โ
    โ โ Acessar app              โ
    โ โ Reenviar verificaรงรฃo     โ
    โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโ
             โ
             โ Clica link do email
             โ
             โผ
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ VERIFICADO                  โ  email_verified = 1
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
    โ Permissรตes:                 โ
    โ โ Fazer login              โ
    โ โ Acessar app              โ
    โ โ Usar todas as features   โ
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## 5. Fluxo de Dados - Banco de Dados

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Tabela: users                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ id                    โ 1                        โ
โ name                  โ Joรฃo Silva               โ
โ email                 โ joao@gmail.com           โ
โ password_hash         โ $2a$10$...              โ
โ role                  โ user                     โ
โ owner_id              โ 1                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ email_verified        โ 0 โ NOVO (Nรฃo verificado)โ
โ verification_token    โ abc123... โ NOVO         โ
โ verification_expires  โ 1733065201000 โ NOVO    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

         โ (Apรณs verificaรงรฃo)

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Tabela: users                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ id                    โ 1                        โ
โ name                  โ Joรฃo Silva               โ
โ email                 โ joao@gmail.com           โ
โ password_hash         โ $2a$10$...              โ
โ role                  โ user                     โ
โ owner_id              โ 1                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ email_verified        โ 1 โ VERIFICADO           โ
โ verification_token    โ NULL                     โ
โ verification_expires  โ NULL                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

**Diagramas criados em: 30 de Novembro de 2025**
